# Analyzing SMTP Log Using Splunk SIEM

## Introduction
SMTP (Simple Mail Transfer Protocol) log files contain valuable information about email communication, including sender and recipient addresses, timestamps, email subjects, and more. Analyzing SMTP logs using Splunk SIEM enables security professionals to monitor email traffic, detect anomalies, and identify potential security threats.

## Project Overview
In this project, we will upload sample SMTP log files to Splunk SIEM and perform various analyses to gain insights into email communication within the network.

## Prerequisites
Before starting the project, ensure the following:
- Splunk instance is installed and configured.
- SMTP log data sources are configured to forward logs to Splunk.

## Steps to Upload Sample SMTP Log Files to Splunk SIEM

### 1. Prepare Sample SMTP Log Files
- Obtain sample [SMTP log file](https://www.secrepo.com/maccdc2012/smtp.log.gz) in a suitable format (e.g., text files).
- Ensure the log files contain relevant SMTP events, including timestamps, sender and recipient addresses, email subjects, etc.
- Save the sample log files in a directory accessible by the Splunk instance.

### 2. Upload Log Files to Splunk
- Log in to the Splunk web interface.
- Navigate to **Settings** > **Add Data**.
  
  <img width="863" height="771" alt="1" src="https://github.com/user-attachments/assets/d381697e-c90c-4dc0-a269-0d9c82b7f22e" />

- Select **Upload** as the data input method.

  <img width="1391" height="421" alt="2" src="https://github.com/user-attachments/assets/7591fafb-b247-4fe2-97e6-c75806604dc8" />


### 3. Choose File
- Click on **Select File** and choose the sample SMTP log file you prepared earlier.
  
  <img width="1263" height="719" alt="3" src="https://github.com/user-attachments/assets/54920a6e-ccc8-4c39-a5b3-267d665f6dab" />


### 4. Set Source Type
- In the **Set Source Type** section, specify the source type for the uploaded log file.
- Choose the appropriate source type for SMTP logs (e.g., `mail` or a custom source type if applicable).
  
  <img width="844" height="531" alt="4" src="https://github.com/user-attachments/assets/6572a918-54dd-4e92-8fdf-094e8f67e06f" />

### 5. Review Settings
- Review other settings such as index, host, and sourcetype.
- Ensure the settings are configured correctly to match the sample SMTP log file.
  
  <img width="1344" height="879" alt="5" src="https://github.com/user-attachments/assets/e9026a89-5c01-4388-8169-bd43a71968f4" />

### 6. Click Upload
- Once all settings are configured, click on the **Review** button.
- Review the settings one final time to ensure accuracy.
- Click **Submit** to upload the sample SMTP log file to Splunk.
  
  <img width="1331" height="522" alt="6" src="https://github.com/user-attachments/assets/aabf0014-198b-4892-bc57-1933da37374a" />

### 7. Verify Upload
- After uploading, navigate to the search bar in the Splunk interface.
  
  <img width="1416" height="706" alt="7" src="https://github.com/user-attachments/assets/330e7b8a-a56a-432d-b53c-93015713fc0b" />

- Run a search query to verify that the uploaded SMTP events are visible.
  
  <img width="1920" height="882" alt="8" src="https://github.com/user-attachments/assets/5f3b4cf0-9f92-4fea-adf3-6ba344152380" />

## Steps to Analyze SMTP Log Files in Splunk SIEM


### 1. Search for SMTP Events
- Open Splunk interface and navigate to the search bar.
- Enter the following search query to retrieve SMTP events
```
index=_* OR index=* sourcetype=smtplog
```
<img width="1920" height="875" alt="9" src="https://github.com/user-attachments/assets/932bfddb-cb1f-4505-ae09-0ca5893c62d8" />


### 2. Extract Relevant Fields
- Identify key fields in SMTP logs such as timestamps, sender and recipient addresses, email subjects, etc.
- Use Splunk's field extraction capabilities or regular expressions to extract these fields for better analysis.
- Example extraction command
```
index=_* OR index=* sourcetype=smtplog
| rex field=_raw "^(?<time>\d+\.\d+)\t(?<uid>\S+)\t(?<src_ip>\d{1,3}(?:\.\d{1,3}){3})\t(?<src_port>\d+)\t(?<dest_ip>\d{1,3}(?:\.\d{1,3}){3})\t(?<dest_port>\d+)\t(?<helo>\S+)\t(?<mail_from>[^\t]+)\t(?<rcpt_to>[^\t]+).*?\t(?<smtp_reply_code>\d{3})\s+(?<smtp_reply_message>[^\t]+)\t(?<relay_path>[^\t]+)\t(?<session_state>[A-Z-]+)$"
```
<img width="1920" height="889" alt="10" src="https://github.com/user-attachments/assets/86c3f1cc-c464-4792-bbb8-fe7a9935c914" />


### 3. Analyze Email Traffic Patterns
- Determine the distribution of email senders:
```
index=_* OR index=* sourcetype=smtplog
| top limit=10 sender_address
```
<img width="1920" height="532" alt="11" src="https://github.com/user-attachments/assets/0a7a8433-1975-439e-8521-c496a77ebabf" />


- Identify top recipient addresses:
```
index=_* OR index=* sourcetype=smtplog
| top limit=10 recipient_address
```
<img width="1920" height="516" alt="12" src="https://github.com/user-attachments/assets/45733a6d-e16b-40e0-a212-76fd35576311" />


### 4. Detect Anomalies
- Look for unusual patterns in email traffic:
```
index=_* OR index=* sourcetype=smtplog
| timechart span=1h count
```
<img width="1920" height="885" alt="13" src="https://github.com/user-attachments/assets/16234296-52e2-48ca-b20b-c966a94ad1fa" />


- Investigate emails with unusual attachment types or sizes:
```
index=_* OR index=* sourcetype=smtplog
| search attachment_type="unusual_type" OR attachment_size > 1000000
```
<img width="1920" height="340" alt="14" src="https://github.com/user-attachments/assets/61f44021-ac01-4495-b0ea-5bf2e3b62125" />


### 5. Monitor User Behavior
- Monitor user behavior related to email communication:
```
index=_* OR index=* sourcetype=smtplog
| stats count by user
```
<img width="1920" height="399" alt="15" src="https://github.com/user-attachments/assets/e9428fc3-d8c5-4c56-9949-8eab5425b655" />


- Identify users with multiple failed login attempts or unauthorized access attempts to email accounts:
```
index=_* OR index=* sourcetype=smtplog
| search action="login" status="failed"
| stats count by user
```
<img width="1920" height="426" alt="16" src="https://github.com/user-attachments/assets/43dc87d6-08af-4471-ae27-91b70835b53b" />


- Analyze email activity patterns and deviations from normal behavior:
```
index=_* OR index=* sourcetype=smtplog
| timechart span=1d count by user
```
<img width="1920" height="519" alt="17" src="https://github.com/user-attachments/assets/f55adbd4-dece-4c33-a5bc-bd5bebb6e770" />



## Conclusion
Analyzing SMTP log files with Splunk SIEM enhances network security by monitoring email traffic, detecting anomalies, and correlating data for threat detection. By leveraging Splunk's capabilities, organizations can proactively identify and respond to email-based threats, ensuring the integrity and confidentiality of their communications.


